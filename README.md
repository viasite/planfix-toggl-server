# Planfix-Toggl server
Интеграция Planfix и Toggl, отправляет данные из Toggl в Планфикс, сделан для того, чтобы избавить людей,
трекающих свою активность в Toggl, от ручного переноса данных в Планфикс.

Вольное описание в [блоге](http://blog.popstas.ru/blog/2018/03/01/planfix-toggl-integration/), конкретное - ниже.



## Правила
Вы должны указывать записям в Toggl id задач Планфикса в виде тегов, например, 12345.

При запуске скрипт получает последние 50 записей, находит среди них записи с id задач и отправляет на email задачи.

После успешной отправки к записи добавляется тег `sent`, чтобы не отправить повторно.

Если запустить уже отправленную запись toggl, из нее в течение минуты будет автоматом стерт тег `sent`.

Записи, сделанные не вами (в командном аккаунте) игнорируются.



## Установка
1. Скачайте [последний релиз](https://github.com/viasite/planfix-toggl-server/releases) в папку
2. Заполните config.yml, добавьте туда ваши пароли и прочие нужные пустые поля, описние полей ниже 



## Использование
Просто запустите.

Для облегчения проставления тегов в записи было дописано официальное расширение Toggl Chrome,
скорее всего, pull request никогда не примут, поэтому я форкнул расширение и опубликовал, для
[Chrome](https://chrome.google.com/webstore/detail/toggl-button-planfix-edit/hkhchfdjhfegkhkgjongbodaphidfmcl) и
[Firefox](https://addons.mozilla.org/ru/firefox/addon/toggl-button-planfix/).

Кое-какую информацию можно смотреть через веб-интерфейс на http://localhost:8096



## Постоянное использование
Добавьте задачу в планировщик заданий Windows:

- при включении компьютера
- путь к planfix-toggl-server.exe
- аргументы: `-no-console`
- укажите рабочую папку 



## Настройка

### Клиент
В конфиге `config.default.yml` указаны настройки для viasite, вы можете переопределить их на свои.

На данный момент (0.2) существует два способа отправки данных в Планфикс: через email и через Планфикс API,
если есть возможность, пользуйтесь вторым способом, он надежнее и требует меньше настроек. К сожалению,
он сработает только для сотрудников viasite, т.к. там часть id захардкожена.
  
Настройки для всех:

- `togglSentTag` - тег, которым помечаются отправленные toggl-записи
- `togglApiToken` - токен Toggl, в настройках profile в Toggl
- `togglWorkspaceId` - посмотрите в url вашего workspace в Toggl
- `planfixAccount` - поддомен вашего Планфикс аккаунта
- `sendInterval` - период отправки данных в Планфикс, в минутах

Настройки для отправки через email:

- `smtpHost`, `smtpPort`, `smtpSecure` - настройки SMTP для отправки. Нужно настроить на свой рабочий ящик, который связан с аккаунтом в Планфиксе
- `smtpLogin`, `smtpPassword` - логин и пароль от вашей почты (настройки по умолчанию для Яндекс почты)
- `smtpEmailFrom` - должен совпадать с email вашего аккаунта в Планфиксе и у smtp должно быть право отправлять письма от этого имени
- `planfixAnaliticTypeValue` - как называется поминутная аналитика, которую вы хотите проставлять в Планфикс
- `planfixAuthorName` - ваше Имя Фамилия в Планфиксе

Настройки для отправки через Планфикс API:
- `planfixApiUrl` - URL API, для аккаунтов в России он будет другим
- `planfixUserName`, `planfixUserPassword` - ваш логин и пароль в Планфиксе

Также, нужно описать все поля аналитики, которые будут заполняться:
- `planfixAnaliticName` - выработка
- `planfixAnaliticTypeName` - вид работы (справочник работ)
- `planfixAnaliticTypeValue` - поминутная работа программиста (вид работы)
- `planfixAnaliticCountName` - кол-во (минут)
- `planfixAnaliticCommentName` - комментарий / ссылка (текст, описание аналитики)
- `planfixAnaliticDateName` - дата (день, без времени)
- `planfixAnaliticUsersName` - сотрудник (мультиполе сотрудников)

Для осторожных: все данные, включая пароли, отправляются только на `planfixApiUrl`, все исходники открыты,
из внешних зависимостей используется только go-toggl.

Прочие настройки:
- `debug` - включает больше вывода (которого и без того много)
- `logFile` - лог, туда отправляется все то же, что и в консоль



### Настройка Планфикса для обработки email
Управление аккаунтом -> Работа с помощью e-mail -> Правила обработки для задач -> Новое правло

У вас конечно будут другие названия полей, если вы не работаете в viasite.

#### Параметры отбора:
- Тема письма содержит текст: `@toggl`
- Содержание письма содержит слово: `time:`
#### Операции:
- Добавить аналитику: Выработка
- Вид работы: `Вид работы:` (до конца строки)
- Дата: `Дата:` (до конца строки)
- Кол-во: `time:` (до конца строки)
- Сотрудник: `Автор:` (до конца строки)
#### Также
- Удалить всё, начиная с метки: `Вид работы:` (в содержании письма)
